# ST-MT-002-001: Create Document Entities and Rule Processing System

## 1. Sub-Task Overview
- **Sub-Task ID:** ST-MT-002-001
- **Sub-Task Name:** Create Document Entities and Rule Processing System
- **Parent Task:** MT-002: AI-Powered Development Automation with Document Generation
- **Estimated Duration:** 5 hours
- **Implementation Type:** Code

## 2. Deliverable Specification
- **Primary Output:** Document entities (PRD, TRD) and rule entities with processing system
- **Code Location:** 
  - `cli/internal/domain/entities/documents.go` - PRD, TRD, and base document entities
  - `cli/internal/domain/entities/rules.go` - Rule entities for generation
  - `cli/internal/adapters/secondary/files/document_processor.go` - Document processing
  - `cli/internal/adapters/secondary/rules/rule_manager.go` - Rule management
- **Technical Requirements:** Go structs, file I/O, metadata extraction, validation, rule parsing
- **Interface Definition:** Document entities, Rule entities, and processing interfaces

## 3. Implementation Details
- **Step-by-Step Approach:**
  1. Create base Document entity for shared functionality
  2. Create PRD and TRD entities extending Document
  3. Create Rule entity for generation rules
  4. Implement document processing interface
  5. Create rule manager for loading and customizing rules
  6. Add support for Markdown and YAML formats
  7. Implement default rule templates from embedded files
  8. Create validation and error handling

- **Code Examples:**
  ```go
  // Base document entity
  type Document struct {
      ID           string            `json:"id" validate:"required,uuid"`
      Type         DocumentType      `json:"type" validate:"required,oneof=prd trd main_tasks sub_tasks"`
      Name         string            `json:"name" validate:"required,min=1,max=200"`
      FilePath     string            `json:"file_path"`
      ContentHash  string            `json:"content_hash"`
      Content      string            `json:"content" validate:"required"`
      Format       Format            `json:"format" validate:"required,oneof=markdown yaml text"`
      Metadata     map[string]interface{} `json:"metadata"`
      Repository   string            `json:"repository" validate:"required"`
      CreatedAt    time.Time         `json:"created_at"`
      UpdatedAt    time.Time         `json:"updated_at"`
      GeneratedBy  string            `json:"generated_by,omitempty"` // AI model or rule used
      ParentDoc    string            `json:"parent_doc,omitempty"`   // For TRD->PRD relationship
  }
  
  type DocumentType string
  const (
      DocumentTypePRD      DocumentType = "prd"
      DocumentTypeTRD      DocumentType = "trd"
      DocumentTypeMainTasks DocumentType = "main_tasks"
      DocumentTypeSubTasks  DocumentType = "sub_tasks"
  )
  
  // PRD entity with specific fields
  type PRD struct {
      Document
      Sections     PRDSections  `json:"sections"`
      ParsedAt     *time.Time   `json:"parsed_at,omitempty"`
  }
  
  type PRDSections struct {
      Introduction    string   `json:"introduction"`
      Goals          []string  `json:"goals"`
      UserStories    []string  `json:"user_stories"`
      Requirements   []string  `json:"requirements"`
      // ... other PRD sections
  }
  
  // TRD entity with technical fields
  type TRD struct {
      Document
      TechStack    []string     `json:"tech_stack"`
      Architecture string       `json:"architecture"`
      PRDReference string       `json:"prd_reference" validate:"required"`
  }
  
  // Rule entity for generation rules
  type Rule struct {
      ID          string       `json:"id" validate:"required"`
      Name        string       `json:"name" validate:"required"`
      Type        RuleType     `json:"type" validate:"required,oneof=prd trd main_tasks sub_tasks"`
      Version     string       `json:"version" validate:"required"`
      Content     string       `json:"content" validate:"required"` // The .mdc rule content
      IsDefault   bool         `json:"is_default"`
      IsCustom    bool         `json:"is_custom"`
      Metadata    RuleMetadata `json:"metadata"`
      CreatedAt   time.Time    `json:"created_at"`
      UpdatedAt   time.Time    `json:"updated_at"`
  }
  
  type RuleType string
  const (
      RuleTypePRD       RuleType = "prd"
      RuleTypeTRD       RuleType = "trd" 
      RuleTypeMainTasks RuleType = "main_tasks"
      RuleTypeSubTasks  RuleType = "sub_tasks"
  )
  
  type RuleMetadata struct {
      Description  string   `json:"description"`
      Author      string   `json:"author"`
      Tags        []string `json:"tags"`
      RequiredSections []string `json:"required_sections"`
  }
  
  type Metadata struct {
      Title         string   `json:"title"`
      Description   string   `json:"description"`
      Version       string   `json:"version"`
      Authors       []string `json:"authors"`
      LastModified  *time.Time `json:"last_modified"`
      WordCount     int      `json:"word_count"`
      SectionCount  int      `json:"section_count"`
      EstimatedComplexity string `json:"estimated_complexity"`
  }
  
  type Format string
  const (
      FormatMarkdown Format = "markdown"
      FormatText     Format = "text"
  )
  
  // Document processor interface
  type DocumentProcessor interface {
      ProcessFile(filePath string, docType DocumentType) (*Document, error)
      ProcessContent(content string, docType DocumentType) (*Document, error)
      ValidateDocument(doc *Document) error
      ExtractSections(content string, docType DocumentType) (interface{}, error)
  }
  
  // Rule manager interface
  type RuleManager interface {
      LoadDefaultRules() error
      GetRule(ruleType RuleType) (*Rule, error)
      SetCustomRule(rule *Rule) error
      ListRules() ([]*Rule, error)
      ValidateRule(rule *Rule) error
  }
  
  // Rule manager implementation
  type DefaultRuleManager struct {
      rules   map[RuleType]*Rule
      storage RuleStorage
      logger  *slog.Logger
  }
  
  //go:embed rules/*.mdc
  var defaultRulesFS embed.FS
  
  func NewDefaultRuleManager(storage RuleStorage, logger *slog.Logger) *DefaultRuleManager {
      return &DefaultRuleManager{
          rules:   make(map[RuleType]*Rule),
          storage: storage,
          logger:  logger,
      }
  }
  
  func (rm *DefaultRuleManager) LoadDefaultRules() error {
      defaultRules := map[RuleType]string{
          RuleTypePRD:       "rules/create-prd.mdc",
          RuleTypeTRD:       "rules/create-trd.mdc", 
          RuleTypeMainTasks: "rules/generate-main-tasks.mdc",
          RuleTypeSubTasks:  "rules/generate-sub-tasks.mdc",
      }
      
      for ruleType, path := range defaultRules {
          content, err := defaultRulesFS.ReadFile(path)
          if err != nil {
              return fmt.Errorf("failed to load default rule %s: %w", ruleType, err)
          }
          
          rule := &Rule{
              ID:        string(ruleType) + "_default",
              Name:      fmt.Sprintf("Default %s Rule", ruleType),
              Type:      ruleType,
              Version:   "1.0.0",
              Content:   string(content),
              IsDefault: true,
              IsCustom:  false,
              CreatedAt: time.Now(),
              UpdatedAt: time.Now(),
          }
          
          // Extract metadata from rule content
          rule.Metadata = rm.extractRuleMetadata(string(content))
          
          rm.rules[ruleType] = rule
      }
      
      return nil
  }
  
  func (rm *DefaultRuleManager) GetRule(ruleType RuleType) (*Rule, error) {
      // Check for custom rule first
      customRule, err := rm.storage.GetCustomRule(ruleType)
      if err == nil && customRule != nil {
          return customRule, nil
      }
      
      // Fall back to default rule
      if rule, exists := rm.rules[ruleType]; exists {
          return rule, nil
      }
      
      return nil, fmt.Errorf("no rule found for type: %s", ruleType)
  }
  ```

- **Configuration Changes:** None required
- **Dependencies:**
  - `github.com/google/uuid`
  - `crypto/sha256`
  - `encoding/hex`
  - `embed` (for embedded rule files)
  - `gopkg.in/yaml.v3` (for YAML parsing)

## 4. Acceptance Criteria
- **Functional Criteria:**
  - Document entities support PRD, TRD, main tasks, and sub-tasks types
  - Rule entities store and manage generation rules
  - Default rules load from embedded files
  - Custom rules can override defaults
  - Document processor handles multiple formats (Markdown, YAML, text)
  - Rule manager provides rule versioning and customization
  - Document relationships tracked (e.g., TRD references PRD)
  
- **Technical Criteria:**
  - Entities follow Go conventions with proper validation
  - Rule system supports hot-reloading of custom rules
  - Embedded default rules compile into binary
  - Error handling covers all edge cases
  - Thread-safe rule access for concurrent operations
  
- **Integration Criteria:**
  - Document entities integrate with AI service layer
  - Rule manager integrates with generation engine
  - Storage interfaces support both documents and rules
  - Repository detection works with all document types
  
- **Test Criteria:**
  - All document types tested with sample content
  - Rule loading and customization verified
  - Document relationship tracking validated
  - Concurrent access patterns tested

## 5. Testing Requirements
- **Unit Tests:**
  - Document entity validation for all types (PRD, TRD, main tasks, sub-tasks)
  - Rule entity validation and versioning
  - Rule manager default rule loading
  - Custom rule override functionality
  - Document processor with various formats
  - Rule metadata extraction
  - Concurrent rule access patterns
  - Document relationship tracking

- **Integration Tests:**
  - End-to-end document creation workflow
  - Rule customization and persistence
  - Document generation with custom rules
  - Rule hot-reloading functionality
  
- **Manual Testing:**
  - Import various document types
  - Customize generation rules
  - Test rule versioning and rollback
  - Verify embedded rules work correctly
  
- **Test Data:** Sample documents, custom rule files, edge case scenarios

## 6. Definition of Done
- **Code Complete:** PRD entity and file processor fully implemented
- **Tests Passing:** All file processing scenarios tested (‚â•90% coverage)
- **Documentation Updated:** Godoc for all public interfaces
- **Integration Verified:** Works with repository detection and storage
- **Review Approved:** Code review focusing on file handling security

## 7. Dependencies and Blockers
- **Required Sub-Tasks:** None (foundational task)
- **External Dependencies:** Standard library file I/O, crypto packages
- **Environmental Requirements:** File system access for document import
- **Potential Blockers:** File format parsing complexity, large file handling

## 8. Integration Notes
- **Component Interfaces:** Used by AI processing services and CLI commands
- **Data Flow:** File ‚Üí PRD Entity ‚Üí AI Processing ‚Üí Task Generation
- **Error Handling:** Returns structured errors for file processing failures
- **Configuration Impact:** None

## 9. Current Implementation Status

**Status:** üöß PARTIALLY IMPLEMENTED

**What has been implemented:**
- ‚úÖ Basic document entities (PRDEntity, TRDEntity, MainTask, SubTask) in `/internal/documents/entities.go`
- ‚úÖ Document interface and validation methods
- ‚úÖ Document status constants and rule types
- ‚úÖ Section parsing and keyword extraction utilities
- ‚úÖ Basic complexity estimation algorithm
- ‚úÖ JSON serialization support
- ‚úÖ Rule entity structure with validation

**What is missing:**
- ‚ùå Complete document processor implementation
- ‚ùå File I/O handling for various document formats
- ‚ùå Rule manager with embedded default rules
- ‚ùå Custom rule override functionality
- ‚ùå Advanced metadata extraction
- ‚ùå Document relationship tracking
- ‚ùå Complete validation and error handling
- ‚ùå Thread-safe rule access implementation

**Next steps:**
1. Implement file processor with support for Markdown, YAML, and text formats
2. Create rule manager with embedded default rules from `/internal/documents/rules/`
3. Add custom rule override system
4. Implement comprehensive document validation
5. Add thread-safe rule access patterns

**Deviations from original plan:**
- Document entities are implemented in main MCP server (`/internal/documents/`) rather than CLI-specific location
- Basic structure exists but lacks the full processor and rule management system
- Rule files exist in `/internal/documents/rules/` but rule manager integration is incomplete